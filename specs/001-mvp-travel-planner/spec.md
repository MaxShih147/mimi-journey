# Feature Specification: Mimi Journey MVP - 旅行規劃與軌跡紀錄

**Feature Branch**: `001-mvp-travel-planner`
**Created**: 2026-02-04
**Status**: Draft
**Input**: User description: "依照readme文件 - Mimi Journey MVP 旅行規劃與軌跡紀錄應用程式"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Google 登入與行事曆事件讀取 (Priority: P1)

使用者透過 Google 帳號登入系統，系統自動讀取使用者當天的 Google 行事曆事件，顯示在行程規劃介面上。

**Why this priority**: 這是所有功能的基礎。沒有登入和行事曆整合，後續的地圖顯示、行程規劃都無法進行。這是使用者體驗的起點。

**Independent Test**: 可以獨立測試「使用者登入後能看到當天行事曆事件列表」，即使沒有地圖功能也能驗證行事曆整合是否成功。

**Acceptance Scenarios**:

1. **Given** 使用者尚未登入, **When** 使用者點擊「使用 Google 登入」, **Then** 系統導向 Google 授權頁面，使用者授權後返回應用並顯示登入成功
2. **Given** 使用者已登入且當天有行事曆事件, **When** 使用者進入行程規劃頁面, **Then** 系統顯示當天所有行事曆事件（包含時間、標題、地點）
3. **Given** 使用者已登入但當天無行事曆事件, **When** 使用者進入行程規劃頁面, **Then** 系統顯示空白行程並提示使用者可手動新增停靠點
4. **Given** 使用者登入的 Token 已過期, **When** 使用者執行任何需要授權的操作, **Then** 系統自動刷新 Token 或提示使用者重新登入

---

### User Story 2 - 事件地點地理編碼與地圖顯示 (Priority: P2)

系統將行事曆事件中的地點文字轉換為地理座標，並在地圖上顯示為標記點，讓使用者能直觀地看到當天的所有目的地位置。

**Why this priority**: 地圖視覺化是規劃行程的核心體驗。使用者需要在地圖上看到所有地點才能有效規劃路線和時間。

**Independent Test**: 可以獨立測試「行事曆事件的地點在地圖上正確顯示為標記」，驗證地理編碼和地圖顯示功能。

**Acceptance Scenarios**:

1. **Given** 行事曆事件包含明確地址, **When** 系統處理該事件, **Then** 系統將地址轉換為經緯度座標並在地圖上顯示標記
2. **Given** 行事曆事件包含地標名稱（如「台北101」）, **When** 系統處理該事件, **Then** 系統透過地點搜尋找到對應座標並顯示標記
3. **Given** 行事曆事件的地點無法識別, **When** 系統處理該事件, **Then** 系統在事件列表中標示「地點待確認」並允許使用者手動指定
4. **Given** 使用者點擊地圖上的標記, **When** 標記被選中, **Then** 系統顯示該地點的詳細資訊（名稱、地址、對應的事件時間）

---

### User Story 3 - 手動新增停靠點與路線預覽 (Priority: P3)

使用者可以手動新增行程中的停靠點（如餐廳、加油站、休息點），系統顯示各點之間的建議路線和預估行車時間。

**Why this priority**: 手動新增停靠點讓使用者能補充行事曆中未記錄的地點，路線預覽幫助使用者評估時間安排是否合理。

**Independent Test**: 可以獨立測試「使用者新增停靠點後，系統顯示到達該點的路線和預估時間」。

**Acceptance Scenarios**:

1. **Given** 使用者在行程規劃頁面, **When** 使用者點擊「新增停靠點」並輸入地點, **Then** 系統搜尋並顯示地點建議供使用者選擇
2. **Given** 使用者已選擇一個停靠點, **When** 使用者確認新增, **Then** 系統將停靠點加入行程列表並在地圖上顯示新標記
3. **Given** 行程中有多個停靠點, **When** 使用者選擇交通方式（步行/開車/大眾運輸/自行車）, **Then** 系統顯示各段路線及預估時間
4. **Given** 使用者想調整停靠順序, **When** 使用者拖曳停靠點, **Then** 系統重新計算路線和時間並更新顯示

---

### User Story 4 - 一鍵生成當天行程 (Priority: P4)

使用者可以一鍵讓系統整合所有行事曆事件和停靠點，自動生成一份包含時間軸和路線段的完整行程表。

**Why this priority**: 自動行程生成是本應用的核心價值，將零散的事件和地點整合成可執行的行程計畫。

**Independent Test**: 可以獨立測試「使用者點擊生成行程後，系統產出包含時間表和路線的完整行程」。

**Acceptance Scenarios**:

1. **Given** 使用者已設定好當天的事件和停靠點, **When** 使用者點擊「生成行程」, **Then** 系統計算最佳路線順序並產生時間軸
2. **Given** 系統生成行程後, **When** 使用者查看行程詳情, **Then** 使用者能看到每個地點的抵達/離開時間、行車時間、建議的緩衝時間
3. **Given** 生成的行程有時間衝突（如兩個事件時間重疊）, **When** 系統完成計算, **Then** 系統標示衝突並提供調整建議
4. **Given** 使用者對生成的行程不滿意, **When** 使用者手動調整後重新生成, **Then** 系統依據新的設定重新計算行程

---

### User Story 5 - 前景 GPS 軌跡追蹤 (Priority: P5)

使用者在當天執行行程時，可以開啟 GPS 追蹤功能，系統定期記錄位置並在地圖上即時顯示移動軌跡。

**Why this priority**: 軌跡追蹤讓使用者能記錄實際行程，對比計畫與實際的差異，也為未來的行程參考提供數據。

**Independent Test**: 可以獨立測試「使用者開啟追蹤後，地圖上即時顯示移動軌跡線」。

**Acceptance Scenarios**:

1. **Given** 使用者已登入且有當天行程, **When** 使用者點擊「開始追蹤」, **Then** 系統開始記錄 GPS 位置並在地圖上顯示當前位置
2. **Given** GPS 追蹤進行中, **When** 使用者移動, **Then** 系統每 10 秒（或每移動一定距離）上傳位置點，地圖上繪製軌跡線
3. **Given** 使用者點擊「停止追蹤」, **When** 追蹤結束, **Then** 系統保存完整軌跡並顯示當日移動總覽
4. **Given** 使用者的裝置 GPS 訊號不佳, **When** 系統無法取得精確位置, **Then** 系統顯示訊號狀態並在訊號恢復後繼續記錄

---

### User Story 6 - 停留點自動偵測 (Priority: P6)

系統分析 GPS 軌跡數據，自動偵測使用者在某地停留較長時間的點，並建議將其標記為休息點候選。

**Why this priority**: 自動偵測停留點減少使用者手動操作，提升使用體驗，也讓軌跡數據更有意義。

**Independent Test**: 可以獨立測試「系統從軌跡數據中正確識別出停留超過設定時間的位置」。

**Acceptance Scenarios**:

1. **Given** GPS 追蹤進行中且使用者在某地停留超過 5 分鐘, **When** 系統分析軌跡, **Then** 系統識別該位置為停留點並在地圖上標示
2. **Given** 系統偵測到停留點, **When** 使用者查看停留點列表, **Then** 使用者能看到停留時間和位置資訊
3. **Given** 系統建議的停留點, **When** 使用者確認採用, **Then** 系統將該點加入為正式休息點記錄
4. **Given** 系統誤判的停留點（如紅燈等待）, **When** 使用者標記為忽略, **Then** 系統將該點從建議列表移除

---

### Edge Cases

- 使用者未授權 Google 行事曆存取權限時，系統如何處理？
  - 系統顯示授權引導頁面，說明需要的權限及用途
- 使用者在無網路環境下使用時，系統如何處理？
  - 軌跡追蹤繼續在本地記錄，網路恢復後批次上傳
- 使用者快速切換日期時，系統如何避免重複請求？
  - 實作請求防抖（debounce）和快取機制
- GPS 定位權限被拒絕時，軌跡追蹤功能如何處理？
  - 顯示權限說明頁面，引導使用者開啟定位權限
- 行事曆事件數量過多（超過 50 個）時，系統如何處理？
  - 分頁載入或提供時間範圍篩選

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統 MUST 支援 Google OAuth 2.0 登入，取得使用者的 Google 行事曆讀取權限
- **FR-002**: 系統 MUST 能讀取使用者指定日期的 Google 行事曆事件
- **FR-003**: 系統 MUST 將行事曆事件的地點文字轉換為地理座標（地理編碼）
- **FR-004**: 系統 MUST 在互動式地圖上顯示所有地點標記
- **FR-005**: 系統 MUST 允許使用者手動新增、編輯、刪除停靠點
- **FR-006**: 系統 MUST 支援停靠點的拖曳排序功能
- **FR-007**: 系統 MUST 提供四種交通方式選項：步行、開車、大眾運輸、自行車
- **FR-008**: 系統 MUST 計算並顯示各停靠點之間的路線和預估行車時間
- **FR-009**: 系統 MUST 能自動生成包含時間軸和路線段的完整行程
- **FR-010**: 系統 MUST 支援 GPS 前景追蹤，定期記錄使用者位置
- **FR-011**: 系統 MUST 在地圖上即時繪製使用者的移動軌跡
- **FR-012**: 系統 MUST 保存軌跡數據供日後查看
- **FR-013**: 系統 MUST 自動偵測軌跡中的停留點
- **FR-014**: 系統 MUST 支援 OAuth Token 自動刷新機制
- **FR-015**: 系統 MUST 快取地點的地理編碼結果以減少重複查詢

### Key Entities

- **User**: 系統使用者，包含 Google 帳號資訊、授權 Token、偏好設定
- **DayPlan**: 當天行程計畫，包含日期、所屬使用者、狀態（草稿/已確認）
- **Stop**: 停靠點，包含名稱、地理座標、預計時間、停留時長、類型（事件/手動/休息點）
- **Leg**: 路線段，連接兩個停靠點，包含距離、預估時間、交通方式、路線座標
- **TracePoint**: 軌跡點，包含經緯度、時間戳、精度、速度
- **TraceSegment**: 軌跡段，由多個軌跡點組成的連續路徑
- **PlaceCache**: 地點快取，儲存地點搜尋結果避免重複查詢

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者能在 30 秒內完成 Google 登入並看到當天行事曆事件
- **SC-002**: 95% 的有效地址能成功轉換為地圖座標
- **SC-003**: 使用者能在 2 分鐘內完成「新增停靠點 + 查看路線預覽」的操作
- **SC-004**: 自動生成的行程能在 5 秒內完成計算並顯示
- **SC-005**: GPS 軌跡追蹤時，位置更新延遲不超過 15 秒
- **SC-006**: 停留點偵測準確率達到 80%（正確識別停留超過 5 分鐘的位置）
- **SC-007**: 系統支援同時處理至少 100 位使用者的軌跡上傳
- **SC-008**: 地圖載入和路線顯示能在 3 秒內完成渲染

## Assumptions

- 使用者擁有 Google 帳號並願意授權行事曆存取
- 使用者的行事曆事件有填寫地點資訊（至少部分事件）
- 使用者的裝置支援 GPS 定位功能
- 使用者在前景使用 App 時有穩定的網路連線（追蹤功能例外）
- 初期 MVP 以繁體中文介面為主
- 地理編碼和路線服務使用 Google Maps API
- 軌跡追蹤間隔預設為 10 秒，可根據移動距離動態調整

## Out of Scope

- 背景 GPS 追蹤（需要原生 App，MVP 階段不實作）
- 行事曆事件的雙向同步（MVP 只讀取，不寫回）
- 多人行程協作功能
- 離線地圖下載
- 多語言支援（MVP 僅繁體中文）
- 歷史行程分析和統計報表
- 社群分享功能
